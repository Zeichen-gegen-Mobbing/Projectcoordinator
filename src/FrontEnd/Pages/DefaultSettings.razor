@page "/default-settings"
@using ZgM.ProjectCoordinator.Shared
@using FrontEnd.Services
@using System.ComponentModel.DataAnnotations
@inject IUserSettingsService UserSettingsService

<PageTitle>Default Cost Settings</PageTitle>

<h1>Default Cost Settings</h1>

<p>Configure the default cost calculation used when a user has no custom settings.</p>

@if (isLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="card">
        <div class="card-body">
            <EditForm Model="@settingsModel" OnValidSubmit="@SaveSettings">
                <DataAnnotationsValidator />

                <div class="mb-3">
                    <label for="centsPerKm" class="form-label">Default Cents per Kilometer</label>
                    <InputNumber @bind-Value="settingsModel.CentsPerKilometerSigned" class="form-control" id="centsPerKm" />
                    <ValidationMessage For="@(() => settingsModel.CentsPerKilometerSigned)" />
                    <div class="form-text">This rate is used for distance-based cost calculations when users have no custom
                        settings.</div>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        }
                        Save Default Settings
                    </button>
                </div>
            </EditForm>

            @if (successMessage != null)
            {
                <div class="alert alert-success mt-3" role="alert">
                    @successMessage
                </div>
            }

            @if (errorMessage != null)
            {
                <div class="alert alert-danger mt-3" role="alert">
                    @errorMessage
                </div>
            }
        </div>
    </div>
}

@code {
    private SettingsModel settingsModel = new();
    private bool isLoading = true;
    private bool isSaving;
    private string? successMessage;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        isLoading = true;
        try
        {
            var settings = await UserSettingsService.GetDefaultSettingsAsync();
            settingsModel.CentsPerKilometer = settings.CentsPerKilometer ?? throw new Exception("We should receive Default Settings from Server in any case.");
        }
        catch (Exception)
        {
            errorMessage = "Failed to load default settings";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveSettings()
    {
        isSaving = true;
        successMessage = null;
        errorMessage = null;

        try
        {
            var settings = new UserSettings
            {
                CentsPerKilometer = settingsModel.CentsPerKilometer
            };

            await UserSettingsService.UpsertDefaultSettingsAsync(settings);
            successMessage = "Default settings saved successfully";
        }
        catch (Exception)
        {
            errorMessage = "Failed to save default settings";
        }
        finally
        {
            isSaving = false;
        }
    }

    private class SettingsModel
    {
        public uint CentsPerKilometer { get; set; }

        [Range(1, int.MaxValue, ErrorMessage = "Cost must be at least 1 cent per kilometer")]
        public int CentsPerKilometerSigned
        {
            get { return Convert.ToInt32(CentsPerKilometer); }
            set { CentsPerKilometer = Convert.ToUInt32(value); }
        }
    }
}