@page "/trips"
@using System.Globalization
@using System.ComponentModel.DataAnnotations
@using FrontEnd.Models
@using FrontEnd.Services
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Microsoft.AspNetCore.Components.QuickGrid
@using Microsoft.AspNetCore.Authorization
@using ZgM.ProjectCoordinator.Shared
@attribute [Authorize]

@inject IUserService UserService;
@inject ITripService TripService;
@inject NavigationManager NavigationManager;

<PageTitle>Trip Calculator</PageTitle>
<AuthorizeView Policy="Role:projectcoordination">
    <Authorized>
        <h3>Trip Calculator</h3>
        <p>Diese Seite ermÃ¶glicht es dir, die Reisedauer von den gespeicherten Orten zu berechnen und zu vergleichen.
        </p>

        <FrontEnd.Components.LocationSelector DisableSearch=LocationSelected DisableSelect=LocationSelected OnLocationSelected=LoadTrips
            OnSearchStarted=ClearTrips />

        @if (LocationSelected)
        {
            <div class="text-center my-4">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3"><strong>Calculating trip durations...</strong></p>
                <p class="text-muted">This may take a while (up to three minutes)</p>
            </div>
        }
        else if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" role="alert">
                <strong>Error loading trips:</strong> @errorMessage
            </div>
        }
        else if (trips.Any())
        {
            <QuickGrid Items="trips.AsQueryable()" Class="table table-hover table-bordered table-striped">
                <PropertyColumn Property="@(t => t.UserDisplayName)" Sortable="true" />
                <PropertyColumn Property="@(t => t.Time)" Format="" Sortable="true" IsDefaultSortColumn="true" />
                <PropertyColumn Property="@(t => t.Cost)" Title="Cost (â‚¬)" Format="N2" Sortable="true" />
                <PropertyColumn Property="@(t => t.TransportModeSymbol)" Title="Mode" Sortable="true" />
                <PropertyColumn Property="@(t => t.Place)" Sortable="false" />
            </QuickGrid>
            <small>Time & Distance provided by Â© openrouteservice.org by HeiGIT | Map data Â© OpenStreetMap
                contributors</small>
        }
        else
        {
            <p class="text-muted">Select a location to calculate trip durations from saved places.</p>
        }
    </Authorized>
    <NotAuthorized>
        <div class="alert alert-danger" role="alert">
            <strong>Access Denied</strong> - You do not have permission to access this page. The "projectcoordination"
            role is
            required.
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private readonly ICollection<TripViewModel> trips = new List<TripViewModel>();
    private bool LocationSelected = false;
    private string? errorMessage = null;

    private void ClearTrips()
    {
        trips.Clear();
        errorMessage = null;
        StateHasChanged();
    }

    private async Task LoadTrips(LocationSearchResult result)
    {
        trips.Clear();
        errorMessage = null;
        LocationSelected = true;
        StateHasChanged();
        await Task.Yield();

        try
        {
            Console.WriteLine("Start getting trips");
            foreach (Trip t in (await TripService.GetTripsAsync(result.Latitude, result.Longitude)))
            {
                var trip = new TripViewModel()
                {
                    Place = t.Place,
                    Time = t.Time,
                    Cost = (decimal)t.Cost / 100
                };
                trips.Add(trip);
                StateHasChanged();
                await Task.Yield();
                _ = loadUser(trip);
            }
            
            if (!trips.Any())
            {
                errorMessage = "No trips found. Probably no places are saved.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            Console.WriteLine($"Error loading trips: {ex}");
        }
        finally
        {
            LocationSelected = false;
            StateHasChanged();
            await Task.Yield();
        }
    }

    private async Task loadUser(TripViewModel trip)
    {
        try
        {
            trip.User = await UserService.GetUserAsync(trip.Place.UserId);
        }
        catch (Exception ex)
        {
            trip.User ??= new User(trip.Place.UserId);
            trip.User.DisplayName = $"Error loading name ({trip.Place.UserId})";
            Console.WriteLine($"Error loading user {trip.Place.UserId}: {ex}");
        }
        StateHasChanged();
        await Task.Yield();
    }

    private sealed class TripViewModel
    {
        public User? User { get; set; }
        public string UserDisplayName => User?.DisplayName ?? "Loading Name";
        public required Place Place { get; set; }
        public required TimeSpan Time { get; set; }
        public decimal Cost { get; set; }
        
        public string TransportModeSymbol => Place.TransportMode switch
        {
            TransportMode.Car => "ðŸš—",
            TransportMode.Train => "ðŸš†",
            _ => ""
        };
    }
}